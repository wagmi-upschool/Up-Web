version: 1
frontend:
  framework: nextjs
  platform: node
  runtime:
    node: "20"
  phases:
    preBuild:
      commands:
        - 'echo "ğŸ“¦ Starting preBuild phase..."'
        - 'echo "ğŸ“‚ Current directory: $(pwd)"'
        - 'echo "ğŸ“ Directory contents:"'
        - ls -la
        - 'echo "ğŸ” Checking for package files:"'
        - ls -la package*.json || echo "No package files found"
        - 'echo "ğŸ”§ Node version: $(node --version)"'
        - 'echo "ğŸ“‹ NPM version: $(npm --version)"'
        - 'echo "ğŸ“¥ Installing dependencies with npm ci..."'
        - npm ci || (echo "âš ï¸ npm ci failed, falling back to npm install..." && npm install)
        - 'echo "âœ… Dependencies installed successfully"'
    build:
      commands:
        - 'echo "ğŸ—ï¸ Starting build phase..."'
        - 'echo "ğŸ“‚ Current directory: $(pwd)"'
        - 'echo "ğŸŒ Setting up environment variables..."'
        - 'echo "NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL" >> .env'
        - 'echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$NEXT_PUBLIC_COGNITO_USER_POOL_ID" >> .env'
        - 'echo "NEXT_PUBLIC_COGNITO_USER_CLIENT_ID=$NEXT_PUBLIC_COGNITO_USER_CLIENT_ID" >> .env'
        - 'echo "REMOTE_URL=$REMOTE_URL" >> .env'
        - 'echo "STREAM_URL=$STREAM_URL" >> .env'
        - 'echo "REFLECTION_API_BASE_URL=$REFLECTION_API_BASE_URL" >> .env'
        - 'echo "FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID" >> .env'
        - 'echo "FIREBASE_PRIVATE_KEY_ID=$FIREBASE_PRIVATE_KEY_ID" >> .env'
        - 'echo "FIREBASE_CLIENT_EMAIL=$FIREBASE_CLIENT_EMAIL" >> .env'
        - 'echo "FIREBASE_CLIENT_ID=$FIREBASE_CLIENT_ID" >> .env'
        - 'echo "FIREBASE_CLIENT_X509_CERT_URL=$FIREBASE_CLIENT_X509_CERT_URL" >> .env'
        - 'echo "FIREBASE_PRIVATE_KEY=$FIREBASE_PRIVATE_KEY" >> .env'
        - 'echo "QUIZ_DEFAULT_CONFIG=$QUIZ_DEFAULT_CONFIG" >> .env'
        - 'echo "MIXPANEL_DEFAULT_CONFIG=$MIXPANEL_DEFAULT_CONFIG" >> .env'
        - 'echo "UP_WEB_MIXPANEL_REMOTE_CONFIG_KEY=$UP_WEB_MIXPANEL_REMOTE_CONFIG_KEY" >> .env'
        - 'echo "UP_WEB_QUIZ_REMOTE_CONFIG_KEY=$UP_WEB_QUIZ_REMOTE_CONFIG_KEY" >> .env'
        - 'echo "ğŸ” Debug - Environment variables created:"'
        - cat .env
        - 'echo "ğŸš€ Starting Next.js build..."'
        - npm run build
        - 'echo "âœ… Build completed successfully"'
        - 'echo "ğŸ“¦ Build output summary (from .next):"'
        - ls -la .next
        - 'echo "ğŸ“Š Build size analysis (from .next):"'
        - du -sh .next/*

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
